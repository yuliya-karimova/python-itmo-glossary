<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–ª–æ—Å—Å–∞—Ä–∏–π Backend-Driven UI</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .main-content {
            display: flex;
            gap: 0;
            background-color: #f8f9fa;
        }
        
        .graph-section {
            flex: 1;
            min-width: 0;
        }
        
        .terms-list-section {
            width: 400px;
            height: 800px;
            border-left: 1px solid #dee2e6;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        header h1 {
            font-size: 1.5em;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls input, .controls button {
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .controls input {
            flex: 1;
            min-width: 200px;
        }
        
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .controls button:hover {
            background: #5568d3;
        }
        
        #graph-container {
            width: 100%;
            height: 800px;
            position: relative;
            background: #f8f9fa;
            overflow: hidden;
            cursor: grab;
        }
        
        #graph-container:active {
            cursor: grabbing;
        }
        
        svg {
            cursor: grab;
        }
        
        svg:active {
            cursor: grabbing;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node circle {
            /* –¶–≤–µ—Ç –∑–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç fill –≤ JavaScript */
            stroke: white;
            stroke-width: 3px;
        }
        
        .node text {
            font-size: 11px;
            fill: white;
            font-weight: 500;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .link-label {
            font-size: 10px;
            fill: #666;
            text-anchor: middle;
            background-color: rgba(255, 255, 255, 0.8);
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linejoin: round;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
            z-index: 1000;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip h3 {
            margin-bottom: 5px;
            color: #667eea;
        }
        
        .tooltip p {
            font-size: 12px;
            line-height: 1.4;
        }
        
        .legend {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .terms-list-header {
            padding: 20px;
            background: #667eea;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #5568d3;
            flex-shrink: 0;
        }
        
        .terms-list {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 10px;
        }
        
        .term-item {
            background: white;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .term-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .term-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .term-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .term-item-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            flex: 1;
        }
        
        .term-item.selected .term-item-title {
            color: #667eea;
        }
        
        .term-item-definition {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .delete-btn, .edit-btn {
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
            margin-left: 5px;
        }
        
        .edit-btn {
            background: #667eea;
        }
        
        .edit-btn:hover {
            background: #5568d3;
        }
        
        .delete-btn {
            background: #ff6b6b;
        }
        
        .delete-btn:hover {
            background: #ee5a5a;
        }
        
        .term-item {
            position: relative;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            color: #333;
            background: #e9ecef;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            padding: 30px;
        }
        
        .modal-form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        
        .modal-form-group:last-of-type {
            margin-bottom: 0;
        }
        
        .modal-form label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .modal-form input,
        .modal-form textarea,
        .modal-form select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .modal-form input:focus,
        .modal-form textarea:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-form textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e9ecef;
        }
        
        .modal-actions button {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-save {
            background: #667eea;
            color: white;
        }
        
        .btn-save:hover {
            background: #5568d3;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Å–≤—è–∑–µ–π */
        .links-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .links-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .links-section h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        
        .btn-add-link {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-add-link:hover {
            background: #5568d3;
        }
        
        .link-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .link-item select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .link-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .btn-remove-link {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .btn-remove-link:hover {
            background: #ee5a5a;
        }
        
        .no-links {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö –ì–ª–æ—Å—Å–∞—Ä–∏–π Backend-Driven UI</h1>
        </header>
        
        <div class="controls">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–µ—Ä–º–∏–Ω–∞...">
            <button onclick="searchTerm()">–ü–æ–∏—Å–∫</button>
            <button onclick="openCreateModal()" style="background: #28a745; margin-left: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ä–º–∏–Ω</button>
            <button onclick="restoreFromCSV()" style="background: #28a745; margin-left: 10px;">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ CSV</button>
        </div>
        
        <div class="main-content">
            <div class="graph-section">
                <div id="graph-container">
                    <div class="tooltip" id="tooltip"></div>
                </div>
                
                <div class="legend">
            <h3>–õ–µ–≥–µ–Ω–¥–∞</h3>
            <div class="legend-item">
                <span class="legend-color" style="background: #9c27b0;"></span>
                <span>–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–µ—Ä–º–∏–Ω</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #2196f3;"></span>
                <span>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #667eea;"></span>
                <span>–¢–µ—Ä–º–∏–Ω</span>
            </div>
            <div class="legend-item">
                <span style="display: inline-block; width: 30px; height: 2px; background: #999; margin-right: 5px; vertical-align: middle;"></span>
                <span>–°–≤—è–∑—å –º–µ–∂–¥—É —Ç–µ—Ä–º–∏–Ω–∞–º–∏</span>
            </div>
            <div class="legend-item" style="margin-top: 10px; font-size: 12px; color: #666;">
                üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —É–∑–µ–ª, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ.
            </div>
            <div class="legend-item" style="margin-top: 5px; font-size: 12px; color: #666;">
                üñ±Ô∏è –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ–Ω –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞ (–¥–æ 200px –≤ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É).
            </div>
                </div>
            </div>
            
            <div class="terms-list-section">
                <div class="terms-list-header">
                    üìã –°–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–æ–≤
                </div>
                <div class="terms-list" id="terms-list">
                    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let graphData = { nodes: [], edges: [] };
        let svg, simulation, tooltip, g;
        let selectedNode = null;
        let nodeRadius = 60; // –†–∞–¥–∏—É—Å —É–∑–ª–∞
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            tooltip = d3.select('#tooltip');
            loadGraph();
            
            // –ü–æ–∏—Å–∫ –ø–æ Enter
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchTerm();
                }
            });
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∞
        async function loadGraph() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∞...');
                const response = await fetch('/api/graph');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                graphData = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', graphData);
                console.log(`–£–∑–ª–æ–≤: ${graphData.nodes.length}, –°–≤—è–∑–µ–π: ${graphData.edges.length}`);
                if (graphData.nodes.length === 0) {
                    console.warn('–ì—Ä–∞—Ñ –ø—É—Å—Ç!');
                    document.getElementById('graph-container').innerHTML = 
                        '<div style="text-align: center; padding: 50px; color: #666;">–ì—Ä–∞—Ñ –ø—É—Å—Ç. –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</div>';
                    return;
                }
                renderGraph();
                renderTermsList();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∞:', error);
                document.getElementById('graph-container').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #d32f2f;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '</div>';
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∞
        function renderGraph() {
            const container = d3.select('#graph-container');
            container.selectAll('*').remove();
            
            const width = container.node().offsetWidth;
            const height = container.node().offsetHeight;
            
            svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // –ì—Ä—É–ø–ø–∞ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π (pan)
            g = svg.append('g');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pan –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            const zoom = d3.zoom()
                .scaleExtent([1, 1]) // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—à—Ç–∞–± (–±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
                .on('zoom', (event) => {
                    // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - –≥—Ä–∞—Ñ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ
                    const t = event.transform;
                    g.attr('transform', `translate(${t.x},${t.y})`);
                })
                .filter((event) => {
                    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º—ã—à—å—é (–Ω–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏)
                    return event.type === 'mousedown' || 
                           (event.type === 'mousemove' && event.buttons === 1) || 
                           event.type === 'mouseup';
                });
            
            svg.call(zoom);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º edges –¥–ª—è D3.js (source –∏ target –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∑–ª–æ–≤)
            const nodeMap = new Map(graphData.nodes.map(n => [n.id, n]));
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç –∫ –∫–∞–∂–¥–æ–º—É —É–∑–ª—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            const colorMap = {
                'root': '#9c27b0',      // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —É–∑–ª–∞
                'approach': '#2196f3',  // –°–∏–Ω–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
                'term': '#667eea'       // –ì–æ–ª—É–±–æ–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
            };
            
            graphData.nodes.forEach(node => {
                const nodeType = node.node_type || 'term';
                node.color = colorMap[nodeType] || colorMap['term'];
            });
            
            const links = graphData.edges.map(e => ({
                source: nodeMap.get(e.source),
                target: nodeMap.get(e.target),
                relation: e.relation
            })).filter(l => l.source && l.target);
            
            console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∏:', links.length);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞
            const centerX = width / 2;
            const centerY = height / 2;
            const sideOffset = 400; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ –±–æ–∫–æ–≤—ã—Ö —É–∑–ª–æ–≤
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–ª—é—á–µ–≤—ã–µ —É–∑–ª—ã
            const rootNode = graphData.nodes.find(n => n.label === '–ü–æ–¥—Ö–æ–¥ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
            const classicNode = graphData.nodes.find(n => n.label === '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ UI');
            const backendNode = graphData.nodes.find(n => n.label === 'Backend-Driven UI');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏—Ö
            if (rootNode) {
                rootNode.x = centerX;
                rootNode.y = centerY;
                rootNode.fx = centerX;  // –§–∏–∫—Å–∏—Ä—É–µ–º –≤ —Ü–µ–Ω—Ç—Ä–µ
                rootNode.fy = centerY;
            }
            
            if (classicNode) {
                classicNode.x = centerX - sideOffset;
                classicNode.y = centerY;
                classicNode.fx = centerX - sideOffset;  // –§–∏–∫—Å–∏—Ä—É–µ–º —Å–ª–µ–≤–∞
                classicNode.fy = centerY;
            }
            
            if (backendNode) {
                backendNode.x = centerX + sideOffset;
                backendNode.y = centerY;
                backendNode.fx = centerX + sideOffset;  // –§–∏–∫—Å–∏—Ä—É–µ–º —Å–ø—Ä–∞–≤–∞
                backendNode.fy = centerY;
            }
            
            // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–∏–ª–∞ –¥–ª—è –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è —É–∑–ª–æ–≤ –æ—Ç –ª–∏–Ω–∏–π –º–µ–∂–¥—É –∫–æ—Ä–Ω–µ–≤—ã–º –∏ –¥–æ—á–µ—Ä–Ω–∏–º–∏ —É–∑–ª–∞–º–∏
            // –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ alpha –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞–ª, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ—Ä–≥–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ
            function avoidLines(alpha) {
                if (!rootNode || !classicNode || !backendNode) return;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
                if (alpha > 0.3) return;
                
                const rootX = rootNode.fx !== null ? rootNode.fx : rootNode.x;
                const rootY = rootNode.fy !== null ? rootNode.fy : rootNode.y;
                const classicX = classicNode.fx !== null ? classicNode.fx : classicNode.x;
                const classicY = classicNode.fy !== null ? classicNode.fy : classicNode.y;
                const backendX = backendNode.fx !== null ? backendNode.fx : backendNode.x;
                const backendY = backendNode.fy !== null ? backendNode.fy : backendNode.y;
                
                const minDistance = 180; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ª–∏–Ω–∏–∏
                const strength = 1.5; // –£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–∏–ª–∞ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è
                
                for (let i = 0; i < graphData.nodes.length; i++) {
                    const node = graphData.nodes[i];
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–∑–ª—ã
                    if (node === rootNode || node === classicNode || node === backendNode) continue;
                    
                    const x = node.x;
                    const y = node.y;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–∏—é 1: –æ—Ç –∫–æ—Ä–Ω—è –∫ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º—É –ø–æ–¥—Ö–æ–¥—É
                    const result1 = checkAndPushFromLine(x, y, rootX, rootY, classicX, classicY, minDistance, strength, alpha);
                    if (result1) {
                        node.vx += result1.vx;
                        node.vy += result1.vy;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–∏—é 2: –æ—Ç –∫–æ—Ä–Ω—è –∫ backend-driven UI
                    const result2 = checkAndPushFromLine(x, y, rootX, rootY, backendX, backendY, minDistance, strength, alpha);
                    if (result2) {
                        node.vx += result2.vx;
                        node.vy += result2.vy;
                    }
                }
            }
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è –æ—Ç –ª–∏–Ω–∏–∏
            function checkAndPushFromLine(px, py, x1, y1, x2, y2, minDist, strength, alpha) {
                const dx = x2 - x1;
                const dy = y2 - y1;
                const lenSq = dx * dx + dy * dy;
                
                if (lenSq === 0) return null;
                
                // –ü–∞—Ä–∞–º–µ—Ç—Ä t –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–æ–µ–∫—Ü–∏—è –Ω–∞ –æ—Ç—Ä–µ–∑–∫–µ (0-1)
                const t = Math.max(0, Math.min(1, ((px - x1) * dx + (py - y1) * dy) / lenSq));
                
                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ç–æ—á–∫–∏ –Ω–∞ –ª–∏–Ω–∏—é
                const projX = x1 + t * dx;
                const projY = y1 + t * dy;
                
                // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ª–∏–Ω–∏–∏
                const dist = Math.sqrt((px - projX) * (px - projX) + (py - projY) * (py - projY));
                
                // –ï—Å–ª–∏ —É–∑–µ–ª —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –ª–∏–Ω–∏–∏
                if (dist < minDist) {
                    // –í–µ–∫—Ç–æ—Ä –æ—Ç –ø—Ä–æ–µ–∫—Ü–∏–∏ –∫ —É–∑–ª—É (–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏)
                    let pushDx = px - projX;
                    let pushDy = py - projY;
                    const pushDist = Math.sqrt(pushDx * pushDx + pushDy * pushDy);
                    
                    // –ï—Å–ª–∏ —É–∑–µ–ª —Ç–æ—á–Ω–æ –Ω–∞ –ª–∏–Ω–∏–∏, –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ
                    if (pushDist < 1) {
                        // –ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –∫ –ª–∏–Ω–∏–∏
                        pushDx = -dy;
                        pushDy = dx;
                        const perpLen = Math.sqrt(pushDx * pushDx + pushDy * pushDy);
                        if (perpLen > 0) {
                            pushDx /= perpLen;
                            pushDy /= perpLen;
                        }
                    } else {
                        pushDx /= pushDist;
                        pushDy /= pushDist;
                    }
                    
                    // –ü–ª–∞–≤–Ω–∞—è —Å–∏–ª–∞ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è (–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞)
                    const normalizedDist = dist / minDist;
                    const force = (1 - normalizedDist) * (1 - normalizedDist) * strength * alpha;
                    
                    return {
                        vx: pushDx * force,
                        vy: pushDy * force
                    };
                }
                
                return null;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –æ—Ç—Ä–µ–∑–∫–∞
            function distanceToLineSegment(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = -1;
                if (lenSq !== 0) param = dot / lenSq;
                
                let xx, yy;
                
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                
                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(250))
                .force('charge', d3.forceManyBody().strength(-600))
                .force('collision', d3.forceCollide().radius(90))
                .force('avoidLines', avoidLines)
                .alphaDecay(0.02) // –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
                .alpha(1) // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–ª–Ω–æ–π —Å–∏–ª—ã
                .velocityDecay(0.6); // –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
            
            // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º force('center'), —á—Ç–æ–±—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–∑–ª—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –Ω–∞ —Å–≤–æ–∏—Ö –º–µ—Å—Ç–∞—Ö
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —É–∑–ª—ã –±—É–¥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å—Å—è –≤–æ–∫—Ä—É–≥ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–Ω–∏–π
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke-width', 2);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–æ–∫ —Å–≤—è–∑–µ–π
            const linkLabels = g.append('g')
                .attr('class', 'link-labels')
                .selectAll('text')
                .data(links)
                .enter().append('text')
                .attr('class', 'link-label')
                .text(d => d.relation)
                .attr('font-size', '10px')
                .attr('fill', '#666')
                .attr('text-anchor', 'middle')
                .attr('pointer-events', 'none')
                .style('user-select', 'none');
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —É–∑–ª–æ–≤
            const node = g.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            node.append('circle')
                .attr('r', nodeRadius)
                .attr('fill', d => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ —É–∑–ª–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                    return d.color || '#667eea';
                })
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', selectNode);
            
            // –¢–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–∞ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫
            node.each(function(d) {
                const nodeElement = d3.select(this);
                const words = d.label.split(' ');
                const maxWordsPerLine = 3;
                // –£–º–µ–Ω—å—à–∞–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤ (–ø–∞–¥–¥–∏–Ω–≥–æ–≤) –æ—Ç –∫—Ä–∞–µ–≤ –∫—Ä—É–≥–∞
                const maxCharsPerLine = 16;
                
                let lines = [];
                let currentLine = '';
                
                words.forEach(word => {
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    if (testLine.length > maxCharsPerLine && currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                });
                if (currentLine) lines.push(currentLine);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
                if (lines.length > maxWordsPerLine) {
                    lines = lines.slice(0, maxWordsPerLine);
                    lines[maxWordsPerLine - 1] = lines[maxWordsPerLine - 1].substring(0, 13) + '...';
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                const fontSize = lines.length > 1 ? 10 : 11;
                const lineHeightEm = 1.2; // –ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ em
                
                const textElement = nodeElement.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle') // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                    .attr('font-size', `${fontSize}px`)
                    .attr('fill', 'white')
                    .attr('font-weight', '500')
                    .attr('pointer-events', 'none')
                    .style('user-select', 'none');
                
                // –î–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏
                if (lines.length === 1) {
                    // –î–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                    textElement.text(lines[0]);
                } else {
                    // –î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫ –≤—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                    // –û–±—â–∞—è –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ = (lines.length - 1) * lineHeightEm
                    // –¶–µ–Ω—Ç—Ä –±–ª–æ–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 0 (–±–ª–∞–≥–æ–¥–∞—Ä—è dominant-baseline="middle")
                    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ —Ü–µ–Ω—Ç—Ä–∞ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É –≤—ã—Å–æ—Ç—ã –±–ª–æ–∫–∞
                    const totalHeight = (lines.length - 1) * lineHeightEm;
                    const firstLineOffset = -totalHeight / 2;
                    
                    lines.forEach((line, i) => {
                        const tspan = textElement.append('tspan')
                            .text(line)
                            .attr('x', 0);
                        if (i === 0) {
                            // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É –≤—ã—Å–æ—Ç—ã –±–ª–æ–∫–∞ –≤–≤–µ—Ä—Ö
                            tspan.attr('dy', `${firstLineOffset}em`);
                        } else {
                            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–º–µ—â–∞—é—Ç—Å—è –Ω–∞ –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                            tspan.attr('dy', `${lineHeightEm}em`);
                        }
                    });
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –º–µ—Ç–æ–∫ —Å–≤—è–∑–µ–π (–Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –ª–∏–Ω–∏–∏)
                linkLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2)
                    .attr('dx', d => {
                        // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –ª–∏–Ω–∏–∏)
                        const dx = d.target.x - d.source.x;
                        const dy = d.target.y - d.source.y;
                        const len = Math.sqrt(dx * dx + dy * dy);
                        if (len === 0) return 0;
                        return (-dy / len) * 12; // –°–º–µ—â–µ–Ω–∏–µ –Ω–∞ 12px –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ
                    })
                    .attr('dy', d => {
                        const dx = d.target.x - d.source.x;
                        const dy = d.target.y - d.source.y;
                        const len = Math.sqrt(dx * dx + dy * dy);
                        if (len === 0) return 0;
                        return (dx / len) * 12; // –°–º–µ—â–µ–Ω–∏–µ –Ω–∞ 12px –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ
                    });
                
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            d.fx = d.x;
            d.fy = d.y;
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª zoom
            event.sourceEvent.stopPropagation();
        }
        
        function dragged(event, d) {
            // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - —É–∑–ª—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            // –§–∏–∫—Å–∏—Ä—É–µ–º —É–∑–µ–ª –Ω–∞ –º–µ—Å—Ç–µ, –≥–¥–µ –µ–≥–æ –æ—Ç–ø—É—Å—Ç–∏–ª–∏
            // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º fx –∏ fy, —á—Ç–æ–±—ã —É–∑–µ–ª –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
        }
        
        function showTooltip(event, d) {
            tooltip
                .html(`<h3>${d.label}</h3><p>${d.definition}</p>`)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .classed('visible', true);
        }
        
        function hideTooltip() {
            tooltip.classed('visible', false);
        }
        
        function selectNode(event, d) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
            selectedNode = d;
            highlightNode(d.id);
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ—Ä–º–∏–Ω –≤ —Å–ø–∏—Å–∫–µ
            highlightTermInList(d.id);
        }
        
        function highlightNode(nodeId) {
            const nodeMap = new Map(graphData.nodes.map(n => [n.id, n]));
            const links = graphData.edges.map(e => ({
                source: nodeMap.get(e.source),
                target: nodeMap.get(e.target)
            })).filter(l => l.source && l.target);
            
            svg.selectAll('.node circle')
                .attr('fill', d => {
                    if (d.id === nodeId) return '#ff6b6b';
                    const connected = links.some(l => 
                        (l.source.id === nodeId && l.target.id === d.id) ||
                        (l.target.id === nodeId && l.source.id === d.id)
                    );
                    if (connected) return '#4ecdc4';
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                    return d.color || '#667eea';
                });
        }
        
        function searchTerm() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                return;
            }
            
            // –ü–æ–∏—Å–∫ —É–∑–ª–∞
            const foundNode = graphData.nodes.find(n => 
                n.label.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (foundNode) {
                highlightNode(foundNode.id);
                highlightTermInList(foundNode.id);
                // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —É–∑–ª–µ
                simulation.alpha(1).restart();
                foundNode.fx = svg.attr('width') / 2;
                foundNode.fy = svg.attr('height') / 2;
                setTimeout(() => {
                    foundNode.fx = null;
                    foundNode.fy = null;
                }, 1000);
            } else {
                alert('–¢–µ—Ä–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–≤
        function renderTermsList() {
            const termsList = document.getElementById('terms-list');
            termsList.innerHTML = '';
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ—Ä–º–∏–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            const sortedNodes = [...graphData.nodes].sort((a, b) => 
                a.label.localeCompare(b.label, 'ru')
            );
            
            sortedNodes.forEach(node => {
                const termItem = document.createElement('div');
                termItem.className = 'term-item';
                termItem.id = `term-item-${node.id}`;
                termItem.setAttribute('data-node-id', node.id);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —ç–ª–µ–º–µ–Ω—Ç–∞
                const header = document.createElement('div');
                header.className = 'term-item-header';
                
                const title = document.createElement('div');
                title.className = 'term-item-title';
                title.textContent = node.label;
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.display = 'flex';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = '‚úé';
                editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    openEditModal(node.id);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '‚úï';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    deleteTerm(node.id, node.label);
                });
                
                buttonsContainer.appendChild(editBtn);
                buttonsContainer.appendChild(deleteBtn);
                
                header.appendChild(title);
                header.appendChild(buttonsContainer);
                
                const definition = document.createElement('div');
                definition.className = 'term-item-definition';
                definition.textContent = node.definition || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                
                termItem.appendChild(header);
                termItem.appendChild(definition);
                
                // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ –≤—ã–¥–µ–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª
                termItem.addEventListener('click', () => {
                    const nodeId = termItem.getAttribute('data-node-id');
                    const node = graphData.nodes.find(n => n.id === nodeId);
                    if (node) {
                        highlightNode(nodeId);
                        highlightTermInList(nodeId);
                    }
                });
                
                termsList.appendChild(termItem);
            });
        }
        
        // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ
        function highlightTermInList(nodeId) {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.term-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –Ω—É–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const termItem = document.getElementById(`term-item-${nodeId}`);
            if (termItem) {
                termItem.classList.add('selected');
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                termItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞
        async function deleteTerm(nodeId, termLabel) {
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Ä–º–∏–Ω "${termLabel}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∏ —Å —ç—Ç–∏–º —Ç–µ—Ä–º–∏–Ω–æ–º.\n\n‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ! –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ CSV".`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/terms/${nodeId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('–¢–µ—Ä–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${response.status}`);
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
                await loadGraph();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert(`–¢–µ—Ä–º–∏–Ω "${termLabel}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞: ${error.message}`);
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV
        async function restoreFromCSV() {
            if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ CSV —Ñ–∞–π–ª–æ–≤?\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n- –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n- –£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ —Å–≤—è–∑–∏\n- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤\n\n–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/import?reset=true', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${response.status}`);
                }
                
                const result = await response.json();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
                await loadGraph();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function openEditModal(nodeId) {
            const node = graphData.nodes.find(n => n.id === nodeId);
            if (!node) {
                alert('–¢–µ—Ä–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞
            document.getElementById('edit-term-id').value = node.id;
            document.getElementById('edit-term-name').value = node.label;
            document.getElementById('edit-term-definition').value = node.definition || '';
            document.getElementById('edit-term-type').value = node.node_type || 'term';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('editModal').classList.add('visible');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–µ—Ä–º–∏–Ω–∞
        async function saveTermChanges() {
            const termId = document.getElementById('edit-term-id').value;
            const termName = document.getElementById('edit-term-name').value.trim();
            const termDefinition = document.getElementById('edit-term-definition').value.trim();
            const termType = document.getElementById('edit-term-type').value;
            
            if (!termName) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            if (!termDefinition) {
                alert('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            try {
                const response = await fetch(`/api/terms/${termId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: termName,
                        definition: termDefinition,
                        node_type: termType
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${response.status}`);
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeEditModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                await loadGraph();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert('–¢–µ—Ä–º–∏–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞: ${error.message}`);
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const createModal = document.getElementById('createModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === createModal) {
                closeCreateModal();
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞
        function openCreateModal() {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('create-term-name').value = '';
            document.getElementById('create-term-definition').value = '';
            document.getElementById('create-term-type').value = 'term';
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π
            const linksContainer = document.getElementById('create-links-container');
            linksContainer.innerHTML = '<div class="no-links">–°–≤—è–∑–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
            linkCounter = 0;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
            populateTermSelects();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('createModal').classList.add('visible');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è
        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('visible');
        }
        
        // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —Å–≤—è–∑–µ–π
        let linkCounter = 0;
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ —Ç–µ—Ä–º–∏–Ω–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
        function populateTermSelects() {
            const selects = document.querySelectorAll('#createModal select.term-select');
            selects.forEach(select => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const currentValue = select.value;
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω...</option>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ù–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω" –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                const newOption = document.createElement('option');
                newOption.value = 'new';
                newOption.textContent = '[–ù–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω]';
                select.appendChild(newOption);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
                graphData.nodes.forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = node.label;
                    select.appendChild(option);
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–≤—è–∑–∏
        function addLink() {
            const linksContainer = document.getElementById('create-links-container');
            
            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–≤—è–∑–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            const noLinks = linksContainer.querySelector('.no-links');
            if (noLinks) {
                noLinks.remove();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–≤—è–∑–∏
            const linkItem = document.createElement('div');
            linkItem.className = 'link-item';
            const linkId = linkCounter++;
            linkItem.id = `link-item-${linkId}`;
            
            linkItem.innerHTML = `
                <select class="term-select link-source" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω...</option>
                </select>
                <input type="text" class="link-relation" placeholder="–¢–∏–ø —Å–≤—è–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç)" required>
                <select class="term-select link-target" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω...</option>
                </select>
                <button type="button" class="btn-remove-link" onclick="removeLink(${linkId})">‚úï</button>
            `;
            
            linksContainer.appendChild(linkItem);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ —Ç–µ—Ä–º–∏–Ω–æ–≤
            populateTermSelects();
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏
        function removeLink(linkId) {
            const linkItem = document.getElementById(`link-item-${linkId}`);
            if (linkItem) {
                linkItem.remove();
                
                // –ï—Å–ª–∏ —Å–≤—è–∑–µ–π –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const linksContainer = document.getElementById('create-links-container');
                if (linksContainer.children.length === 0) {
                    linksContainer.innerHTML = '<div class="no-links">–°–≤—è–∑–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
                }
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞ —Å —Å–≤—è–∑—è–º–∏
        async function createTerm() {
            const termName = document.getElementById('create-term-name').value.trim();
            const termDefinition = document.getElementById('create-term-definition').value.trim();
            const termType = document.getElementById('create-term-type').value;
            
            if (!termName) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            if (!termDefinition) {
                alert('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Ä–º–∏–Ω
                const termResponse = await fetch('/api/terms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: termName,
                        definition: termDefinition,
                        node_type: termType
                    })
                });
                
                if (!termResponse.ok) {
                    const errorData = await termResponse.json().catch(() => ({}));
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞: ${termResponse.status}`);
                }
                
                const newTerm = await termResponse.json();
                
                // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑–∏
                const linkItems = document.querySelectorAll('#createModal .link-item');
                const linkPromises = [];
                
                for (const linkItem of linkItems) {
                    const sourceSelect = linkItem.querySelector('.link-source');
                    const targetSelect = linkItem.querySelector('.link-target');
                    const relationInput = linkItem.querySelector('.link-relation');
                    
                    const sourceId = sourceSelect.value;
                    const targetId = targetSelect.value;
                    const relation = relationInput.value.trim();
                    
                    if (!sourceId || !targetId || !relation) {
                        continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–ø–æ–ª–Ω—ã–µ —Å–≤—è–∑–∏
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ç–µ—Ä–º–∏–Ω —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º, –∞ –∫–∞–∫–æ–π - —Ü–µ–ª—å—é
                    // –ï—Å–ª–∏ sourceId = "new", –∑–Ω–∞—á–∏—Ç –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω - –∏—Å—Ç–æ—á–Ω–∏–∫
                    // –ï—Å–ª–∏ targetId = "new", –∑–Ω–∞—á–∏—Ç –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω - —Ü–µ–ª—å
                    let sourceTermName, targetTermName;
                    
                    if (sourceId === 'new') {
                        sourceTermName = termName;
                        const targetTerm = graphData.nodes.find(n => n.id === targetId);
                        if (!targetTerm) continue;
                        targetTermName = targetTerm.label;
                    } else if (targetId === 'new') {
                        targetTermName = termName;
                        const sourceTerm = graphData.nodes.find(n => n.id === sourceId);
                        if (!sourceTerm) continue;
                        sourceTermName = sourceTerm.label;
                    } else {
                        // –û–±–∞ —Ç–µ—Ä–º–∏–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                        const sourceTerm = graphData.nodes.find(n => n.id === sourceId);
                        const targetTerm = graphData.nodes.find(n => n.id === targetId);
                        if (!sourceTerm || !targetTerm) continue;
                        sourceTermName = sourceTerm.label;
                        targetTermName = targetTerm.label;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑—å
                    const linkPromise = fetch('/api/links', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source: sourceTermName,
                            target: targetTermName,
                            relation: relation
                        })
                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏:', err);
                        return null;
                    });
                    
                    linkPromises.push(linkPromise);
                }
                
                // –ñ–¥–µ–º —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π
                await Promise.all(linkPromises);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeCreateModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ
                await loadGraph();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert('–¢–µ—Ä–º–∏–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞: ${error.message}`);
            }
        }
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ä–º–∏–Ω</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form class="modal-form" onsubmit="event.preventDefault(); saveTermChanges();">
                <input type="hidden" id="edit-term-id">
                <div class="modal-form-group">
                    <label for="edit-term-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞:</label>
                    <input type="text" id="edit-term-name" required>
                </div>
                <div class="modal-form-group">
                    <label for="edit-term-definition">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <textarea id="edit-term-definition" required></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="edit-term-type">–¢–∏–ø —É–∑–ª–∞:</label>
                    <select id="edit-term-type">
                        <option value="term">–¢–µ—Ä–º–∏–Ω</option>
                        <option value="approach">–ü–æ–¥—Ö–æ–¥</option>
                        <option value="root">–ö–æ—Ä–Ω–µ–≤–æ–π</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞ -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω</h2>
                <button class="close-btn" onclick="closeCreateModal()">&times;</button>
            </div>
            <form class="modal-form" onsubmit="event.preventDefault(); createTerm();">
                <div class="modal-form-group">
                    <label for="create-term-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞:</label>
                    <input type="text" id="create-term-name" required>
                </div>
                <div class="modal-form-group">
                    <label for="create-term-definition">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <textarea id="create-term-definition" required></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="create-term-type">–¢–∏–ø —É–∑–ª–∞:</label>
                    <select id="create-term-type">
                        <option value="term">–¢–µ—Ä–º–∏–Ω</option>
                        <option value="approach">–ü–æ–¥—Ö–æ–¥</option>
                        <option value="root">–ö–æ—Ä–Ω–µ–≤–æ–π</option>
                    </select>
                </div>
                <div class="links-section">
                    <div class="links-section-header">
                        <h3>–°–≤—è–∑–∏</h3>
                        <button type="button" class="btn-add-link" onclick="addLink()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å</button>
                    </div>
                    <div id="create-links-container">
                        <div class="no-links">–°–≤—è–∑–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>

